services:
  # YOLOv9n Vehicle Damage Detection System (оптимальная версия)
  vehicle-damage-yolov9n:
    build:
      context: .
      dockerfile: Dockerfile.yolov9n
    container_name: vehicle_damage_yolov9n
    environment:
      # Конфигурация с YOLOv9n моделью
      - DATABASE_URL=sqlite:///./data/detection.db
      - MODEL_PATH=./models
      - UPLOAD_PATH=./uploads
      - MAX_IMAGE_SIZE=10MB
      - LOG_LEVEL=INFO
      
      # YOLOv9n конфигурация
      - YOLO_MODEL=yolov9n.pt
      - YOLO_CONFIDENCE=0.3
      - YOLO_IOU=0.5
      - YOLO_DEVICE=cpu
      - FORCE_CPU=true
      
      # Системные настройки
      - WORKERS=1
      - TIMEOUT=60
      - MAX_CONCURRENT_REQUESTS=3
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./models:/app/models
      - ./src:/app/src
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health', timeout=10)"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s